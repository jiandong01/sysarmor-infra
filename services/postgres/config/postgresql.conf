# PostgreSQL配置文件 - SysArmor优化版本

#------------------------------------------------------------------------------
# 连接和认证设置
#------------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
max_connections = 200
superuser_reserved_connections = 3

#------------------------------------------------------------------------------
# 内存设置
#------------------------------------------------------------------------------
shared_buffers = 256MB                 # 共享缓冲区
effective_cache_size = 1GB             # 有效缓存大小
work_mem = 4MB                          # 工作内存
maintenance_work_mem = 64MB             # 维护工作内存
dynamic_shared_memory_type = posix

#------------------------------------------------------------------------------
# WAL设置
#------------------------------------------------------------------------------
wal_level = replica                     # WAL级别
wal_buffers = 16MB                      # WAL缓冲区
checkpoint_completion_target = 0.9      # 检查点完成目标
max_wal_size = 1GB                      # 最大WAL大小
min_wal_size = 80MB                     # 最小WAL大小

#------------------------------------------------------------------------------
# 查询规划器设置
#------------------------------------------------------------------------------
random_page_cost = 1.1                 # 随机页面成本
effective_io_concurrency = 200         # 有效IO并发

#------------------------------------------------------------------------------
# 日志设置
#------------------------------------------------------------------------------
logging_collector = on                  # 启用日志收集器
log_destination = 'stderr'              # 日志目标
log_directory = '/var/log/postgresql'   # 日志目录
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d                   # 日志轮转时间
log_rotation_size = 100MB               # 日志轮转大小
log_min_duration_statement = 1000       # 记录慢查询(1秒)
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_checkpoints = on                    # 记录检查点
log_connections = on                    # 记录连接
log_disconnections = on                 # 记录断开连接
log_lock_waits = on                     # 记录锁等待
log_temp_files = 10MB                   # 记录临时文件

#------------------------------------------------------------------------------
# 统计设置
#------------------------------------------------------------------------------
track_activities = on                   # 跟踪活动
track_counts = on                       # 跟踪计数
track_io_timing = on                    # 跟踪IO时间
track_functions = pl                    # 跟踪函数

#------------------------------------------------------------------------------
# 自动清理设置
#------------------------------------------------------------------------------
autovacuum = on                         # 启用自动清理
autovacuum_max_workers = 3              # 自动清理最大工作进程
autovacuum_naptime = 1min               # 自动清理间隔
autovacuum_vacuum_threshold = 50        # 自动清理阈值
autovacuum_analyze_threshold = 50       # 自动分析阈值
autovacuum_vacuum_scale_factor = 0.2    # 自动清理比例因子
autovacuum_analyze_scale_factor = 0.1   # 自动分析比例因子

#------------------------------------------------------------------------------
# 客户端连接默认设置
#------------------------------------------------------------------------------
timezone = 'Asia/Shanghai'              # 时区
datestyle = 'iso, mdy'                  # 日期格式
default_text_search_config = 'pg_catalog.english'

#------------------------------------------------------------------------------
# 锁管理
#------------------------------------------------------------------------------
deadlock_timeout = 1s                  # 死锁超时
max_locks_per_transaction = 64          # 每个事务最大锁数

#------------------------------------------------------------------------------
# 错误报告和日志
#------------------------------------------------------------------------------
log_error_verbosity = default           # 错误详细程度
log_min_error_statement = error         # 最小错误语句级别
log_min_messages = warning              # 最小消息级别

#------------------------------------------------------------------------------
# 性能优化
#------------------------------------------------------------------------------
max_parallel_workers = 8                # 最大并行工作进程
max_parallel_workers_per_gather = 2     # 每个收集的最大并行工作进程
max_parallel_maintenance_workers = 2    # 最大并行维护工作进程

#------------------------------------------------------------------------------
# 扩展和模块
#------------------------------------------------------------------------------
shared_preload_libraries = 'pg_stat_statements'  # 预加载库

#------------------------------------------------------------------------------
# 其他设置
#------------------------------------------------------------------------------
max_worker_processes = 8                # 最大工作进程
max_prepared_transactions = 0           # 最大预准备事务
